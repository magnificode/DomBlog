{"data":{"markdownRemark":{"html":"<p>Before you read on, be sure to check out <a href=\"/update/2015/12/20/service-workin-for-the-weekend.html\">my first blog post</a> about the Service Worker API. Service workers require a secure connection, and that post will show you how to set your site up with CloudFlare in order to serve your site via https.</p>\n<h2>First things First</h2>\n<p>Regardless of our end game, we need to register our service worker. We're essentially going to be working in two javascript files. The first one we'll call <code class=\"language-text\">app.js</code> which is where the initial scripts for your site are housed. That is where this first snippet below will be housed.</p>\n<p>{% highlight javascript %}\nif ('serviceWorker' in navigator) {\nnavigator.serviceWorker.register('/your-site/serviceworker.js').then(function(reg) {\nconsole.log('Registration succeeded.');\n}).catch(function(error) {\nconsole.log('Registration failed with ' + error);\n});\n}\n{% endhighlight %}</p>\n<p>Lets break this down and establish what is happening here.</p>\n<p>{% highlight javascript %}\n//Check to see if service worker is supported in the current browser\nif ('serviceWorker' in navigator) {\n// Register our service worker. The register function relates\n// to the javascript file within your site containing the\n// service worker directives.\nnavigator.serviceWorker.register('/your-site/serviceworker.js').then(function(reg) {\n// If the registration worked, success!\nconsole.log('Registration succeeded.');\n}).catch(function(error) {\n// Registration failed.\nconsole.log('Registration failed with ' + error);\n});\n}\n{% endhighlight %}</p>\n<p>The code above is not the service worker itself, rather it is registering our service worker within a scope. That being said, once a page within the scope is loaded, the service worker will run. This happens individually on each page load so long as it is within scope.</p>\n<h2>Cache Rules Everything Around Me</h2>\n<p>Now we get to the juicy stuff. Now that we have registered a service worker, let's look at how we can utilize the cache to grab the files you'd like to utilize for offline mode on your site. In our second file, which I'm calling <code class=\"language-text\">serviceworker.js</code> place this next snippet.</p>\n<p>{% highlight javascript %}\nthis.addEventListener('install', function(event) {\nevent.waitUntil(\ncaches.open('offline').then(function(cache) {\nreturn cache.addAll([\n'/',\n'/index.html',\n'/update/2015/12/29/2015.html',\n'/css',\n'/css/main.css',\n'/app.js',\n'/serviceworker.js'\n]);\n})\n);\n});\n{% endhighlight %}</p>\n<p>Since we are within the the registered service worker the scope allows us to utilize <code class=\"language-text\">this</code>. The first line of this snippet adds an install event listener. We then chain the <code class=\"language-text\">waitUntil</code> method which delays the proceeding code from running until the ES6 promise has been fulfilled. Then, utilizing the <code class=\"language-text\">caches.open</code> method, we open a new cache titled offline. This is where our cached files will be stored. This returns a promise for the cache, and once that is fulfilled we utilize the <code class=\"language-text\">addAll</code> function which adds the specified files to the cache.</p>\n<p>I've added myself the homepage of my site, along with the latest post.</p>\n<p>Lastly we're going to need to tell the browser that when it detects that it's offline, to access the cache that we created with the service worker and utilize the files found there.</p>\n<p>{% highlight javascript %}\nthis.addEventListener('fetch', function(event) {\nvar response;\nevent.respondWith(caches.match(event.request).catch(function() {\nreturn fetch(event.request);\n}).then(function(r) {\nresponse = r;\ncaches.open('offline').then(function(cache) {\ncache.put(event.request, response);\n});\nreturn response.clone();\n}));\n});\n{% endhighlight %}</p>\n<p>We do this by utilizing the fetch event listener which tells the browser to respond with the cache. The first <code class=\"language-text\">.catch</code> function detects if the promise rejects, and returns the default server response. We then utilize the <code class=\"language-text\">.then</code> method to open our offline cache and put the response onto the page.</p>\n<p>You can check out my versions of both the <a href=\"https://github.com/magnificode/magnificode.github.io/blob/master/app.js\">app.js</a> and the <a href=\"https://github.com/magnificode/magnificode.github.io/blob/master/serviceworker.js\">serviceworker.js</a> files.</p>","fields":{"title":"What can we do with ServiceWorker","date":"02 February, 2016"}}},"pageContext":{"slug":"/2016-02-02-what-can-we-do-with-service-workers/"}}